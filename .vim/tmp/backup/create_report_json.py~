"""Parses Excel file for the asin and review ids for a mission's struggles/substruggles."""
import re
import sys
import json
import argparse
import pandas as pd

parser = argparse.ArgumentParser()
parser.add_argument("file", type=str, help="Excel file of report struggles.")
parser.add_argument(
    "save_file", type=str, help="Name of .json file to save results to."
)
args = parser.parse_args()

struggles = {}
sheets = pd.read_excel(args.file, sheet_name=None)  # read all sheets in
# Assume all sheets contain struggle reviews. The names of these sheets will
# be used as the struggle label.
for name, sheet in sheets.items():
    # Get substruggle sheet and remove unnecessary data.
    sheet.columns = [c.lower() for c in sheet.columns]
    sheet = sheet.dropna(axis=1, how="all")
    sheet = sheet.drop(columns="causes", errors="ignore")
    sheet = sheet.astype(str)

    # Get review .json file names for each substruggle.
    substruggles = {}
    for c in sheet.columns:
        substruggles[c.strip()] = [v for v in sheet[c].values if ".json" in v]
    struggles[name] = substruggles

with open(args.save_file, "w") as f:
    json.dump(struggles, f)
